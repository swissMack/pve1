## EMQX MQTT Broker Configuration
## Version: EMQX 5.x
## Purpose: Containerized MQTT Test Ecosystem

## =============================================================================
## Node Configuration
## =============================================================================
node {
  name = "emqx@127.0.0.1"
  cookie = "emqxsecretcookie"
  data_dir = "/opt/emqx/data"
}

## =============================================================================
## Cluster Configuration (single-node for dev/test)
## =============================================================================
cluster {
  name = "emqxcl"
  discovery_strategy = "manual"
}

## =============================================================================
## Dashboard Configuration
## =============================================================================
dashboard {
  listeners {
    http {
      bind = "0.0.0.0:18083"
    }
  }
}

## =============================================================================
## MQTT Listeners
## =============================================================================

## TCP Listener - Port 1883 (FR-001)
listeners.tcp.default {
  bind = "0.0.0.0:1883"
  max_connections = 1024000
  proxy_protocol = false
}

## TLS Listener - Port 8883 (FR-018)
listeners.ssl.default {
  bind = "0.0.0.0:8883"
  max_connections = 512000
  ssl_options {
    cacertfile = "/opt/emqx/etc/certs/ca.crt"
    certfile = "/opt/emqx/etc/certs/server.crt"
    keyfile = "/opt/emqx/etc/certs/server.key"
    verify = verify_none
    fail_if_no_peer_cert = false
    versions = ["tlsv1.3", "tlsv1.2"]
  }
}

## WebSocket Listener - Port 8083 (FR-008)
listeners.ws.default {
  bind = "0.0.0.0:8083"
  max_connections = 1024000
  websocket {
    mqtt_path = "/mqtt"
  }
}

## WebSocket TLS Listener - Port 8084 (FR-009)
listeners.wss.default {
  bind = "0.0.0.0:8084"
  max_connections = 512000
  websocket {
    mqtt_path = "/mqtt"
  }
  ssl_options {
    cacertfile = "/opt/emqx/etc/certs/ca.crt"
    certfile = "/opt/emqx/etc/certs/server.crt"
    keyfile = "/opt/emqx/etc/certs/server.key"
    verify = verify_none
    fail_if_no_peer_cert = false
    versions = ["tlsv1.3", "tlsv1.2"]
  }
}

## =============================================================================
## MQTT Protocol Configuration
## =============================================================================
mqtt {
  ## Maximum packet size - 256KB default (FR-014a)
  max_packet_size = 256KB

  ## Maximum client ID length
  max_clientid_len = 256

  ## Maximum topic levels
  max_topic_levels = 128

  ## Maximum topic aliases (MQTT 5.0)
  max_topic_alias = 65535

  ## Maximum QoS allowed
  max_qos_allowed = 2

  ## Maximum inflight messages for QoS 1/2
  max_inflight = 32

  ## Retry interval for QoS 1/2 messages
  retry_interval = 30s

  ## Session expiry interval (MQTT 5.0)
  session_expiry_interval = 2h

  ## Message expiry interval (MQTT 5.0)
  max_mqueue_len = 1000

  ## Upgrade QoS (disabled - respect publisher QoS)
  upgrade_qos = false

  ## Shared subscription mode
  shared_subscription = true

  ## Wildcard subscription
  wildcard_subscription = true

  ## Exclusive subscription
  exclusive_subscription = false

  ## Client ID takeover policy (FR clarification: takeover)
  ignore_loop_deliver = false

  ## Strict mode for MQTT protocol compliance
  strict_mode = true
}

## =============================================================================
## Session Persistence - T007
## =============================================================================
## Note: EMQX 5.x uses built-in session persistence by default
## Sessions are persisted to data_dir automatically

## =============================================================================
## Zone Configuration
## =============================================================================
zones.default {
  mqtt {
    max_packet_size = 256KB
    max_clientid_len = 256
    max_topic_levels = 128
    max_qos_allowed = 2
    max_inflight = 32
    max_awaiting_rel = 100
    max_mqueue_len = 1000
    mqueue_store_qos0 = true
    retain_available = true
    wildcard_subscription = true
    shared_subscription = true
    exclusive_subscription = false
  }
}

## =============================================================================
## Rate Limiting (FR-014b)
## =============================================================================
limiter {
  ## Connection rate limit: 100 connections/sec per IP (default)
  connection {
    rate = "100/s"
    burst = 0
  }

  ## Message publish rate limit
  message_in {
    rate = "infinity"
  }

  ## Bytes rate limit
  bytes_in {
    rate = "infinity"
  }
}

## =============================================================================
## Flapping Detection (prevent reconnection storms)
## =============================================================================
flapping_detect {
  enable = true
  max_count = 15
  window_time = 1m
  ban_time = 5m
}

## =============================================================================
## Force Shutdown Configuration
## =============================================================================
force_shutdown {
  enable = true
  max_heap_size = 256MB
  max_message_queue_len = 8000
}

## =============================================================================
## Force GC Configuration
## =============================================================================
force_gc {
  enable = true
  count = 16000
  bytes = 16MB
}

## =============================================================================
## Overload Protection
## =============================================================================
overload_protection {
  enable = true
  backoff_delay = 1
  backoff_gc = true
  backoff_hibernation = true
  backoff_new_conn = true
}

## =============================================================================
## Logging Configuration
## =============================================================================
log {
  console {
    enable = true
    level = info
    formatter = text
  }

  file {
    default {
      enable = true
      level = info
      path = "/opt/emqx/log/emqx.log"
      rotation_count = 10
      rotation_size = 50MB
      formatter = text
    }
  }
}

## =============================================================================
## Prometheus Metrics Endpoint (FR-025)
## =============================================================================
## Note: Prometheus metrics are exposed via /api/v5/prometheus/stats
## Configure scraping in prometheus.yml

## =============================================================================
## Sys Topics Configuration
## =============================================================================
sys_topics {
  sys_msg_interval = 1m
  sys_heartbeat_interval = 30s
  sys_event_messages {
    client_connected = true
    client_disconnected = true
    client_subscribed = true
    client_unsubscribed = true
  }
}

## =============================================================================
## Telemetry (disabled for privacy)
## =============================================================================
telemetry {
  enable = false
}

## =============================================================================
## Authorization Configuration
## =============================================================================
authorization {
  no_match = allow
  deny_action = disconnect
  cache {
    enable = true
    max_size = 32
    ttl = 1m
  }
  sources = [
    {
      type = file
      enable = true
      path = "/opt/emqx/etc/acl.conf"
    }
  ]
}
