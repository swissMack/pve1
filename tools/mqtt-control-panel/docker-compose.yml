# MQTT Control Panel - Docker Compose Configuration
# Provides a web-based control panel for managing MQTT data generators
# and monitoring EMQX broker status

services:
  # Backend API Server (Node.js/Express)
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mqtt-control-panel-backend
    environment:
      # MQTT Configuration (REQUIRED)
      MQTT_BROKER_URL: ${MQTT_BROKER_URL:-mqtt://mqtt-emqx:1883}
      # EMQX Management API (REQUIRED)
      EMQX_API_URL: ${EMQX_API_URL:-http://mqtt-emqx:18083}
      # API Port
      API_PORT: ${API_PORT:-3003}
      # Docker directory for container control (if needed)
      DOCKER_DIR: ${DOCKER_DIR:-/root/MQTTServer/docker}
    networks:
      - mqtt-control-network
      - mqtt-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3003/api/generator/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Frontend (Nginx serving Vue.js)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: mqtt-control-panel-frontend
    ports:
      - "${CONTROL_PANEL_PORT:-5174}:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - mqtt-control-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

networks:
  mqtt-control-network:
    driver: bridge
  mqtt-network:
    external: true
